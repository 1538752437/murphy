<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Muphy Coffee</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
  <style>
    body { 
      font-family: 'Lato', sans-serif; 
      background-color: #1a1a1a; 
      color: #e0c097; 
      position: relative; 
      overflow-x: hidden; 
      min-height: 100vh; 
      margin: 0;
      padding: 0;
    }
    .navbar { 
      background: linear-gradient(135deg, #1a1a1a 0%, #d4a373 100%); 
      padding: 10px; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
    }
    .navbar-brand, .nav-link { 
      color: #e0c097 !important; 
      font-family: 'Playfair Display', serif; 
      font-size: 1.1rem; 
      transition: color 0.3s ease; 
    }
    .navbar-brand { 
      font-size: 1.5rem; 
      font-weight: 700; 
    }
    .nav-link { 
      padding: 8px 12px !important; 
    }
    .nav-link:hover { 
      color: #d4a373 !important; 
    }
    .hero { 
      background: url('https://images.pexels.com/photos/1695052/pexels-photo-1695052.jpeg?auto=compress&cs=tinysrgb&w=1200') no-repeat center; 
      background-size: cover; 
      padding: 80px 0; 
      color: #e0c097; 
      text-align: center; 
      position: relative; 
      text-shadow: 2px 2px 8px rgba(0,0,0,0.8); 
    }
    .hero::before { 
      content: ''; 
      position: absolute; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%; 
      background: rgba(0,0,0,0.6); 
      z-index: 1; 
    }
    .hero .container { 
      position: relative; 
      z-index: 2; 
    }
    .hero h1 { 
      font-family: 'Playfair Display', serif; 
      font-size: 2rem; 
      font-weight: 700; 
      margin-bottom: 10px; 
      color: #d4a373; 
    }
    .hero p { 
      font-size: 1rem; 
      font-weight: 300; 
    }
    .card { 
      border: 1px solid rgba(212,163,115,0.2); 
      border-radius: 15px; 
      background: #333333; 
      box-shadow: 0 6px 20px rgba(212,163,115,0.1); 
      transition: transform 0.3s ease, box-shadow 0.3s ease; 
      cursor: pointer; 
      margin-bottom: 15px; 
      opacity: 0; 
      animation: fadeIn 0.5s ease forwards; 
      animation-delay: calc(var(--delay) * 0.2s); 
    }
    .card:hover { 
      transform: translateY(-5px); 
      box-shadow: 0 10px 25px rgba(212,163,115,0.2); 
    }
    .card-img-top { 
      border-radius: 15px 15px 0 0; 
      height: 150px; 
      width: 100%; 
      object-fit: cover; 
    }
    .card-body { 
      padding: 10px; 
      text-align: center; 
    }
    .card-title { 
      font-family: 'Playfair Display', serif; 
      font-size: 1.1rem; 
      color: #d4a373; 
    }
    .card-text { 
      font-size: 0.85rem; 
      color: #b89b6f; 
    }
    .category-section, .product-section, .cart-section, .my-order-section { 
      padding: 30px 0; 
      background-color: #2c2c2c; 
      border-radius: 15px; 
      margin: 15px 0; 
      box-shadow: 0 4px 12px rgba(0,0,0,0.3); 
    }
    .btn { 
      touch-action: manipulation; 
      -webkit-tap-highlight-color: transparent; 
      padding: 8px 16px; 
      font-size: 0.9rem; 
      border-radius: 25px; 
      transition: transform 0.2s ease, background 0.3s ease; 
    }
    .btn:hover { 
      transform: scale(1.05); 
    }
    .btn-primary { 
      background: linear-gradient(135deg, #d4a373 0%, #1a1a1a 100%); 
      border: none; 
    }
    .btn-primary:hover { 
      background: linear-gradient(135deg, #1a1a1a 0%, #d4a373 100%); 
    }
    .btn-success { 
      background: linear-gradient(135deg, #d4a373 0%, #1a1a1a 100%); 
      border: none; 
    }
    .btn-success:hover { 
      background: linear-gradient(135deg, #1a1a1a 0%, #d4a373 100%); 
    }
    .btn-danger { 
      background: linear-gradient(135deg, #dc3545 0%, #1a1a1a 100%); 
      border: none; 
    }
    .btn-danger:hover { 
      background: linear-gradient(135deg, #1a1a1a 0%, #c82333 100%); 
    }
    .footer { 
      background: linear-gradient(135deg, #1a1a1a 0%, #d4a373 100%); 
      color: #e0c097; 
      padding: 15px 0; 
      text-align: center; 
      margin-top: 20px; 
      font-size: 0.8rem; 
    }
    .loading { 
      text-align: center; 
      color: #d4a373; 
      font-style: italic; 
      padding: 15px; 
      position: relative; 
    }
    .loading::after { 
      content: ''; 
      display: inline-block; 
      width: 20px; 
      height: 20px; 
      border: 3px solid #d4a373; 
      border-radius: 50%; 
      border-top-color: transparent; 
      animation: spin 1s ease-in-out infinite; 
      margin-left: 8px; 
    }
    .list-group-item { 
      background-color: #333333; 
      color: #e0c097; 
      border-color: rgba(212,163,115,0.2); 
      font-size: 0.9rem; 
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    h2 { 
      font-family: 'Playfair Display', serif; 
      color: #d4a373; 
      font-size: 1.8rem; 
      font-weight: 700; 
      margin-bottom: 15px; 
    }
    @media (max-width: 768px) {
      .hero { 
        padding: 50px 0; 
      }
      .hero h1 { 
        font-size: 1.5rem; 
      }
      .hero p { 
        font-size: 0.9rem; 
      }
      .navbar-brand { 
        font-size: 1.2rem; 
      }
      .nav-link { 
        font-size: 0.9rem; 
        padding: 6px 8px !important; 
      }
      .category-section, .product-section, .cart-section, .my-order-section { 
        padding: 20px 0; 
        margin: 10px 0; 
      }
      .card-img-top { 
        height: 120px; 
      }
      .card-body { 
        padding: 8px; 
      }
      .card-title { 
        font-size: 1rem; 
      }
      .card-text { 
        font-size: 0.8rem; 
      }
      .btn { 
        font-size: 0.85rem; 
        padding: 6px 12px; 
      }
      h2 { 
        font-size: 1.3rem; 
      }
      .list-group-item { 
        font-size: 0.85rem; 
      }
      #cart-items, #my-order { 
        max-height: 250px; 
        overflow-y: auto; 
      }
      .container {
        padding-left: 10px;
        padding-right: 10px;
      }
    }
    @media (max-width: 576px) {
      .col-md-3 { 
        flex: 0 0 50%; 
        max-width: 50%; 
      }
      .card-img-top { 
        height: 100px; 
      }
      .btn-sm { 
        font-size: 0.8rem; 
        padding: 5px 10px; 
      }
    }
    @media (max-width: 400px) {
      .col-md-3 { 
        flex: 0 0 100%; 
        max-width: 100%; 
      }
      .card-img-top { 
        height: 150px; 
      }
    }
    .modal-content {
      background-color: #333333;
      color: #e0c097;
      border: 1px solid rgba(212,163,115,0.2);
    }
    .modal-header, .modal-footer {
      border-color: rgba(212,163,115,0.2);
    }
    .modal-title {
      font-family: 'Playfair Display', serif;
      color: #d4a373;
    }
    .form-control {
      background-color: #444444;
      color: #e0c097;
      border: 1px solid rgba(212,163,115,0.2);
    }
    .form-control:focus {
      background-color: #444444;
      color: #e0c097;
      border-color: #d4a373;
      box-shadow: 0 0 5px rgba(212,163,115,0.3);
    }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, push, update, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAKaVwadaKpdjtYPN1qWIvh6Rkben-Y5KQ",
      authDomain: "muphycoffee.firebaseapp.com",
      databaseURL: "https://muphycoffee-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "muphycoffee",
      storageBucket: "muphycoffee.firebasestorage.app",
      messagingSenderId: "247009315808",
      appId: "1:247009315808:web:9a63a7648509cc42c0b985",
      measurementId: "G-B5ZT58WP1Q"
    };

    try {
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);

      let cart = [];
      let currentCategory = null;
      let currentOrderId = null;

      async function loadProducts(category = null) {
        const hotProductsSection = document.querySelector('#hot-product .row');
        if (!hotProductsSection) {
          console.error('Hot products section not found in DOM');
          return;
        }
        hotProductsSection.innerHTML = '<p class="loading">加载中...</p>';

        try {
          const productsRef = ref(db, 'products');
          console.log('Attempting to load products from:', productsRef.toString());

          onValue(productsRef, (snapshot) => {
            hotProductsSection.innerHTML = '';
            if (!snapshot.exists()) {
              console.log('No products found in database');
              hotProductsSection.innerHTML = '<p class="loading">暂无商品，请联系管理员添加商品。</p>';
              return;
            }

            let hasProducts = false;
            let delay = 0;
            snapshot.forEach((childSnapshot) => {
              const product = childSnapshot.val();
              const productId = childSnapshot.key;
              if (category && product.category !== category) return;

              hasProducts = true;
              const card = document.createElement('div');
              card.className = 'col-md-3';
              card.style.setProperty('--delay', delay);
              card.innerHTML = `
                <div class="card">
                  <img src="${product.imageUrl || 'https://images.pexels.com/photos/3400193/pexels-photo-3400193.jpeg?auto=compress&cs=tinysrgb&w=150'}" class="card-img-top" alt="${product.name}" onerror="this.src='https://images.pexels.com/photos/3400193/pexels-photo-3400193.jpeg?auto=compress&cs=tinysrgb&w=150'">
                  <div class="card-body">
                    <h5 class="card-title">${product.name}</h5>
                    <p class="card-text">${product.description}</p>
                    <button class="btn btn-primary btn-sm" onclick="addToCart('${productId}')">加入购物车</button>
                  </div>
                </div>
              `;
              hotProductsSection.appendChild(card);
              delay++;
            });

            if (!hasProducts) {
              console.log('No products found for category:', category || 'All');
              hotProductsSection.innerHTML = '<p class="loading">此分类暂无商品。</p>';
            }
          }, (error) => {
            console.error('Error loading products:', error.message, error.code);
            hotProductsSection.innerHTML = `<p class="loading">加载商品失败：${error.message} (${error.code})，请检查权限或联系管理员。</p>`;
          });
        } catch (error) {
          console.error('Error in loadProducts:', error.message);
          hotProductsSection.innerHTML = `<p class="loading">加载商品失败：${error.message}，请检查网络或配置。</p>`;
        }
      }

      window.filterProducts = function(category) {
        currentCategory = category;
        loadProducts(category);
        document.getElementById('hot-product').scrollIntoView({ behavior: 'smooth' });
      };

      window.addToCart = function(id) {
        const productRef = ref(db, 'products/' + id);
        onValue(productRef, (snapshot) => {
          const product = snapshot.val();
          if (product) {
            const existingItem = cart.find(item => item.id === id);
            if (existingItem) {
              existingItem.quantity += 1;
            } else {
              cart.push({ id, name: product.name, price: product.price, quantity: 1 });
            }
            updateCartDisplay();
            alert(`${product.name} 已添加到购物车！`);
          }
        }, { onlyOnce: true }, (error) => {
          console.error('Error adding to cart:', error.message);
          alert('添加商品失败：' + error.message);
        });
      };

      function updateCartDisplay() {
        const cartItems = document.querySelector('#cart-items');
        if (!cartItems) return;
        cartItems.innerHTML = cart.length ? '' : '<li class="list-group-item">购物车为空。</li>';
        let total = 0;
        cart.forEach(item => {
          const itemTotal = item.price * item.quantity;
          total += itemTotal;
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `${item.name} x ${item.quantity} - ￥${itemTotal} <button class="btn btn-danger btn-sm" onclick="removeFromCart('${item.id}')">移除</button>`;
          cartItems.appendChild(li);
        });
        document.querySelector('#cart-total').textContent = `总计: ￥${total}`;
      }

      window.removeFromCart = function(id) {
        cart = cart.filter(item => item.id !== id);
        updateCartDisplay();
      };

      function displayMyOrder(orderId, orderData) {
        const myOrderSection = document.querySelector('#my-order-section');
        const myOrderDisplay = document.querySelector('#my-order');
        if (!myOrderSection || !myOrderDisplay) {
          console.error('My order section or display element not found!');
          return;
        }
        console.log('Displaying order:', orderId, orderData);
        myOrderDisplay.innerHTML = '';
        const itemsList = Array.isArray(orderData.items) 
          ? orderData.items.map(item => `${item.name} x ${item.quantity}`).join(', ')
          : '未知商品';
        myOrderDisplay.innerHTML = `
          <li class="list-group-item">
            取餐号: ${orderData.orderNumber || orderId}<br>
            客户姓名: ${orderData.customerName || '未知客户'}<br>
            电话号码: ${orderData.customerPhone || '无电话'}<br>
            商品: ${itemsList}<br>
            总金额: ￥${orderData.total || 0}<br>
            状态: ${orderData.status || '未知'}
          </li>
        `;
        myOrderSection.style.display = 'block'; // 确保 section 可见
      }

      const checkoutButton = document.querySelector('#checkout-button');
      if (checkoutButton) {
        checkoutButton.addEventListener('click', () => {
          if (cart.length === 0) {
            alert('购物车为空，请先添加商品！');
            return;
          }

          const modal = document.createElement('div');
          modal.innerHTML = `
            <div class="modal fade" id="checkoutModal" tabindex="-1" aria-labelledby="checkoutModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="checkoutModalLabel">填写订单信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <form id="checkoutForm">
                      <div class="mb-3">
                        <label for="customerName" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="customerName" required>
                      </div>
                      <div class="mb-3">
                        <label for="customerPhone" class="form-label">电话号码</label>
                        <input type="tel" class="form-control" id="customerPhone" required>
                      </div>
                    </form>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-success" id="submitOrder">提交订单</button>
                  </div>
                </div>
              </div>
            </div>
          `;
          document.body.appendChild(modal);

          const modalInstance = new bootstrap.Modal(document.getElementById('checkoutModal'));
          modalInstance.show();

          const submitOrderButton = document.getElementById('submitOrder');
          if (submitOrderButton) {
            submitOrderButton.addEventListener('click', async () => {
              const customerName = document.getElementById('customerName').value.trim();
              const customerPhone = document.getElementById('customerPhone').value.trim();

              if (!customerName || !customerPhone) {
                alert('请填写姓名和电话号码！');
                return;
              }

              try {
                const orderData = {
                  customerName, 
                  customerPhone, 
                  items: cart,
                  total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                  createdAt: new Date().toISOString(),
                  status: 'pending',
                  orderNumber: `ORDER_${Date.now()}`
                };
                const orderRef = await push(ref(db, 'orders'), orderData);
                currentOrderId = orderRef.key;
                console.log('Order submitted successfully, currentOrderId:', currentOrderId);
                console.log('Initial order data:', orderData);

                const orderSnapshot = await get(ref(db, `orders/${currentOrderId}`));
                if (orderSnapshot.exists()) {
                  console.log('Order verified in database:', orderSnapshot.val());
                } else {
                  console.error('Order not found in database after writing!');
                  throw new Error('订单写入失败，请检查数据库权限。');
                }

                await update(ref(db, `orders/${currentOrderId}`), { orderNumber: currentOrderId });
                alert(`订单提交成功！您的取餐号是：${currentOrderId}`);

                const orderStatusRef = ref(db, `orders/${currentOrderId}`);
                onValue(orderStatusRef, (snapshot) => {
                  if (snapshot.exists()) {
                    const orderData = snapshot.val();
                    console.log('Order data updated:', orderData);
                    displayMyOrder(currentOrderId, orderData);
                  } else {
                    console.error('Order not found for ID:', currentOrderId);
                    document.querySelector('#my-order').innerHTML = '<li class="list-group-item">订单加载失败，请检查权限或联系管理员。</li>';
                  }
                }, (error) => {
                  console.error('Error listening to order updates:', error.message);
                  document.querySelector('#my-order').innerHTML = '<li class="list-group-item">订单加载失败：' + error.message + '，请检查权限或联系管理员。</li>';
                });

                cart = [];
                updateCartDisplay();
                document.getElementById('my-order-section').scrollIntoView({ behavior: 'smooth' });
                modalInstance.hide();
              } catch (error) {
                console.error('Error submitting order:', error.message);
                alert('订单提交失败：' + error.message);
                document.querySelector('#my-order').innerHTML = '<li class="list-group-item">订单提交失败：' + error.message + '</li>';
              }
            });
          } else {
            console.error('Submit order button not found!');
          }
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        loadProducts();
      });
    } catch (error) {
      console.error('Firebase initialization failed:', error);
      alert('Firebase 初始化失败，请检查配置或网络！');
    }
  </script>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container">
      <a class="navbar-brand" href="/">Muphy Coffee</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Close">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item"><a class="nav-link" href="#home">首页</a></li>
          <li class="nav-item"><a class="nav-link" href="#menu">菜单</a></li>
          <li class="nav-item"><a class="nav-link" href="#cart">购物车</a></li>
          <li class="nav-item"><a class="nav-link" href="#my-order-section">我的订单</a></li>
          <li class="nav-item"><a class="nav-link" href="#about">关于我们</a></li>
          <li class="nav-item"><a class="nav-link" href="#contact">联系我们</a></li>
          <li class="nav-item"><a class="nav-link" href="/admin/">管理员登录</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <section id="home" class="hero">
    <div class="container">
      <h1>欢迎来到 Muphy Coffee</h1>
      <p>品味生活，从一杯咖啡开始</p>
    </div>
  </section>

  <section id="menu" class="category-section">
    <div class="container">
      <h2>热门分类</h2>
      <div class="row">
        <div class="col-md-3" style="--delay: 0">
          <div class="card" onclick="filterProducts('特色咖啡')">
            <img src="https://images.pexels.com/photos/324028/pexels-photo-324028.jpeg?auto=compress&cs=tinysrgb&w=300" class="card-img-top" alt="特色咖啡" onerror="this.src='https://images.pexels.com/photos/324028/pexels-photo-324028.jpeg?auto=compress&cs=tinysrgb&w=300'">
            <div class="card-body">
              <h5 class="card-title">特色咖啡</h5>
              <p class="card-text">精选咖啡豆</p>
            </div>
          </div>
        </div>
        <div class="col-md-3" style="--delay: 1">
          <div class="card" onclick="filterProducts('茶类饮品')">
            <img src="https://images.pexels.com/photos/1417945/pexels-photo-1417945.jpeg?auto=compress&cs=tinysrgb&w=300" class="card-img-top" alt="茶类饮品" onerror="this.src='https://images.pexels.com/photos/1417945/pexels-photo-1417945.jpeg?auto=compress&cs=tinysrgb&w=300'">
            <div class="card-body">
              <h5 class="card-title">茶类饮品</h5>
              <p class="card-text">天然草本茶</p>
            </div>
          </div>
        </div>
        <div class="col-md-3" style="--delay: 2">
          <div class="card" onclick="filterProducts('甜点蛋糕')">
            <img src="https://images.pexels.com/photos/291528/pexels-photo-291528.jpeg?auto=compress&cs=tinysrgb&w=300" class="card-img-top" alt="甜点蛋糕" onerror="this.src='https://images.pexels.com/photos/291528/pexels-photo-291528.jpeg?auto=compress&cs=tinysrgb&w=300'">
            <div class="card-body">
              <h5 class="card-title">甜点蛋糕</h5>
              <p class="card-text">新鲜烘焙</p>
            </div>
          </div>
        </div>
        <div class="col-md-3" style="--delay: 3">
          <div class="card" onclick="filterProducts('简餐小食')">
            <img src="https://images.pexels.com/photos/1893555/pexels-photo-1893555.jpeg?auto=compress&cs=tinysrgb&w=300" class="card-img-top" alt="简餐小食" onerror="this.src='https://images.pexels.com/photos/1893555/pexels-photo-1893555.jpeg?auto=compress&cs=tinysrgb&w=300'">
            <div class="card-body">
              <h5 class="card-title">简餐小食</h5>
              <p class="card-text">健康轻食</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section id="hot-product" class="product-section">
    <div class="container">
      <h2>热门商品</h2>
      <div class="row">
        <!-- 商品会通过JavaScript动态加载 -->
      </div>
    </div>
  </section>

  <section id="cart" class="cart-section">
    <div class="container">
      <h2>购物车</h2>
      <ul id="cart-items" class="list-group mb-3"></ul>
      <p id="cart-total" class="text-center">总计: ￥0</p>
      <div class="text-center"><button id="checkout-button" class="btn btn-success">提交订单</button></div>
    </div>
  </section>

  <section id="my-order-section" class="my-order-section">
    <div class="container">
      <h2>我的订单</h2>
      <ul id="my-order" class="list-group mb-3">
        <li class="list-group-item">请提交订单以查看取餐号和订单状态。</li>
      </ul>
    </div>
  </section>

  <section id="about" class="category-section">
    <div class="container">
      <h2>关于我们</h2>
      <p>Muphy Coffee 提供高品质的咖啡和舒适的环境，让每一位顾客享受美好的咖啡时光。</p>
    </div>
  </section>

  <section id="hours" class="category-section">
    <div class="container">
      <h2>营业时间</h2>
      <ul class="list-group">
        <li class="list-group-item">周一至周五: 7:00 - 21:00</li>
        <li class="list-group-item">周六: 8:00 - 22:00</li>
        <li class="list-group-item">周日: 8:00 - 20:00</li>
      </ul>
    </div>
  </section>

  <section id="contact" class="category-section">
    <div class="container">
      <h2>联系我们</h2>
      <p>福建省泉州市丰泽区黎明大学旁<br>010-12345678<br>support@muphycoffee.com</p>
    </div>
  </section>

  <footer class="footer">
    <div class="container">
      <p>© 2025 Muphy Coffee. 保留所有权利。</p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
